name: CI

on:
  push:
    branches: [feature/**, dev, QA, main]
  pull_request:
    branches: [dev, QA, main]

jobs:
  validate-static-site:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: "20"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set target branch context
        run: echo "TARGET_BRANCH=${GITHUB_BASE_REF:-${GITHUB_REF_NAME}}" >> "$GITHUB_ENV"

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-modules-

      - name: Install dependencies
        run: npm ci

      - name: Run lint (if available) on feature/dev/QA
        if: ${{ env.TARGET_BRANCH != 'main' }}
        run: npm run lint --if-present 2>&1 | tee lint.log

      - name: Run lint (strict) on main
        if: ${{ env.TARGET_BRANCH == 'main' }}
        run: npm run lint 2>&1 | tee lint.log

      - name: Run TypeScript type check
        run: npm run typecheck 2>&1 | tee typecheck.log

      - name: Build project
        run: npm run build 2>&1 | tee build.log

      - name: Verify static export directory exists
        run: |
          test -d out || { echo "Missing static export directory: ./out"; exit 1; }

      - name: Validate security files
        run: |
          test -f public/.well-known/security.txt || { echo "Missing public/.well-known/security.txt"; exit 1; }
          test -f public/.well-known/pgp-key.txt || { echo "Missing public/.well-known/pgp-key.txt"; exit 1; }

      - name: Validate Next.js static export config
        run: |
          grep -Eq "output:\s*['\"]export['\"]" next.config.ts || { echo "next.config.ts must include output: 'export'"; exit 1; }

      - name: Enforce no warnings on QA/main
        if: ${{ env.TARGET_BRANCH == 'QA' || env.TARGET_BRANCH == 'main' }}
        run: |
          for file in lint.log typecheck.log build.log; do
            if [ -f "$file" ] && grep -Eiq '\bwarning\b' "$file"; then
              echo "Warnings detected in $file (not allowed on $TARGET_BRANCH)."
              exit 1
            fi
          done

      - name: "Strict check (main): no console.log in production code"
        if: ${{ env.TARGET_BRANCH == 'main' }}
        run: |
          matches="$(grep -RIn --include='*.ts' --include='*.tsx' --exclude-dir='__tests__' 'console\.log(' app components lib || true)"
          if [ -n "$matches" ]; then
            echo "$matches"
            echo "console.log found in production code."
            exit 1
          fi
